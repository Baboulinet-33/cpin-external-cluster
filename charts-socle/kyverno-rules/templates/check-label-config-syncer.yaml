apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-label-config-syncer
  annotations:
    policies.kyverno.io/title: Check label config Syncer
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: ConfigMap, Secret
    kyverno.io/kyverno-version: 1.6.0
    kyverno.io/kubernetes-version: "1.22-1.23"
    policies.kyverno.io/description: >-
      This policy checks for the presence of the 'kubed.appscode.com/sync' annotation on ConfigMaps and Secrets. 
      If the annotation is present, it must not be empty. The aim is to ensure that synchronized resources have 
      proper information for control and management.
spec:
  validationFailureAction: {{ .Values.validationFailureAction }}
  rules:
  - name: check-label-non-empty-on-secret-for-config-syncer
#    skipBackgroundRequests: true
    match:
      any:
      - resources:
          kinds:
          - Secret
          - ConfigMap
    validate:
      message: "Le label 'kubed.appscode.com/sync' doit être non vide s'il est présent"
      pattern:
        metadata:
          =(annotations):
            =(kubed.appscode.com/sync): "?*"
    exclude:
      any:
      - resources:
          namespaces:
            {{- range .Values.excludedNamespaces }}
            - "{{ . }}"
            {{- end }}
